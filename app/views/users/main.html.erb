<input type="hidden" id="login" value="<%= @user.login %>">

<ul id='iframes' class="nav nav-tabs">
  <% @user.json_content.each_with_index do |row , index| %>
    <li id="<%= index %>" class="<%= 'active' if index == 0  %>"><a data-toggle="tab" href="#link<%= index %>"><%= row['src'] %><button class="close closeTab" type="button" id="<%= row['guid']%>" >Ã—</button></a></li>
  <% end %>
  <button onclick="addTab()" class="btn btn-success">Add</button>
</ul>

<div class="tab-content">
  <% @user.json_content.each_with_index do |row , index| %>
    <div id="link<%= index %>" class="tab-pane fade <%= 'in active' if index == 0  %>">
      <iframe src="<%= row['src'] %>"></iframe>
    </div>
  <% end %>
</div>



<script text="text/javascript">

  setInterval(function(){
    var elementos = $('ul li').toArray();

    var ativo = elementos.find(function (el) { return $(el).hasClass("active"); });

    var proximoId = 0;

    if (parseInt($(ativo).attr("id")) + 1 < $('ul li').toArray().length)
      proximoId = parseInt($(ativo).attr("id"))+1;

    var src = $("#link" + proximoId + " iframe").attr("src");

    $("#link" + proximoId + " iframe").attr("src", src);

    $("#" + proximoId + " a").click();

  }, 30000);


  //this method will register event on close icon on the tab..
  function registerCloseEvent() {

      $(".closeTab").click(function () {

        var button = $(this);

          removeTab(button.attr("id"), function (argument) {

            var tabContentId = button.parent().attr("href");
            button.parent().parent().remove();
            $('#iframes a:last').tab('show');
            $(tabContentId).remove();

          })

      });


  }

  function removeTab(guid, callback) {
    $.ajax({
        url: "/options/remove_tab/" + $("#login").val(),
        type:'DELETE',
        data: { 'guid': guid }
    }).done(callback)
  }

  var addTab = function(){
    var url = prompt("Please enter your url", "http://");

    if (url != null) {
        $.ajax({
          url: "/options/add_tab/" + $("#login").val(),
          type:'POST',
          data: { 'url': url }
        })
    }
  }

  $(function () {
    registerCloseEvent();
  })

</script>

